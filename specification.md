# キャンプ場予約管理システム 仕様書

## 1. 概要
本システムは、楽天トラベルキャンプからの予約メールを自動で取り込み、Googleスプレッドシートドで一元管理するとともに、お客様への自動メール送信やGoogleカレンダーへの連携を行う業務効率化ツールです。
また、専用のWeb管理画面（GAS Web App）を通じて、直感的な予約確認やステータス変更、メール文面の編集が可能です。

## 2. システム構成
- **プラットフォーム**: Google Apps Script (GAS)
- **データベース**: Google スプレッドシート
- **入力ソース**: Gmail (楽天トラベルキャンプからの通知メール)
- **出力先**: Googleカレンダー, Gmail (お客様への送信)
- **UI**: HTML/CSS/JS (GAS Web Appとしてデプロイ)

## 3. 主要機能

### 3.1 予約情報の自動抽出 (`gmail_to_sheets.js`)
- **トリガー**: 定期実行 (推奨: 1時間ごと)
- **機能**:
    - 指定期間（デフォルト7日間）のGmailを検索。
    - 検索条件: `from:no-reply@camp.travel.rakuten.co.jp` かつ 件名に「予約が確定しました」または「予約がキャンセルされました」。
    - **確定メール**: 予約情報を抽出し、スプレッドシートに新規行として追加。
        - 抽出項目: 予約日時, 予約ID, チェックイン/アウト日時, サイト名, 人数, 名前, 電話番号, メール, 備考, 料金。
        - ステータス初期値: 「予約中」。
    - **キャンセルメール**: 該当する予約IDの行を探し、ステータスを「キャンセル済み」に更新。
    - **自動チェックイン**: 予約中でチェックイン日時を過ぎたものは自動で「チェックイン完了」に更新。

### 3.2 カレンダー連携 (`sync_calendar.js`)
- **トリガー**: `gmail_to_sheets.js` 実行後、または Web画面でのステータス変更時。
- **機能**:
    - スプレッドシートの予約データをGoogleカレンダーに同期。
    - **新規追加**: ステータス「予約中」で、まだカレンダーIDが記録されていない未来の予約を作成。
    - **削除**: ステータス「キャンセル済み」になった予約のイベントを削除。

### 3.3 自動メール送信 (`mail_to_client.js`)
- **トリガー**: 定期実行 (推奨: 1日1回 朝など)
- **機能**: 以下の2種類のメールを条件に合わせて送信。
    1.  **予約翌日 (南京錠のお知らせ)**: 予約日が「昨日」の顧客へ送信。
    2.  **宿泊前日 (リマインド)**: チェックイン日が「明日」の顧客へ送信。
- **仕様**:
    - 送信済みフラグをシートで管理し、重複送信を防止。
    - `config.js` の `DRY_RUN` 設定により、送信テストが可能。
    - テストモード時は宛先を強制的に管理者のアドレスなどに変更可能。

### 3.4 Web管理画面 (`webapp.js`, `index.html`)
- **URLアクセス**: デプロイされたWebアプリURLからアクセス。
- **機能**:
    - **リストビュー**: 予約情報をカード形式で一覧表示。検索・フィルタリング（ステータス別）が可能。
    - **カレンダービュー**: FullCalendarを使用し、月表示/リスト表示で予約状況を可視化。
    - **詳細モーダル**: 予約の詳細確認、電話発信リンク。
    - **ステータス変更**: 「チェックイン完了」「キャンセル済み」へのステータス変更（カレンダー同期も即時実行）。
    - **設定画面**: 自動送信メールの「件名」「本文」「添付ファイルID」をWeb上で編集・保存可能。本文内のタグ（`{名前}`, `{予約ID}`など）は送信時に自動置換される。

## 4. データ構造 (スプレッドシート)

主要な列と役割は以下の通り。

| 列名 | 説明 |
| :--- | :--- |
| **予約日時** | メールの受信日時 |
| **予約ID** | 楽天トラベルの予約ID (キー項目) |
| **チェックイン日時** | 宿泊開始日時 |
| **チェックアウト日時** | 宿泊終了日時 |
| **名前** | 顧客名 |
| **電話番号** | 連絡先 |
| **メールアドレス** | 連絡先メール |
| **ステータス** | `予約中`, `チェックイン完了`, `キャンセル済み` |
| **南京錠送信済み** | 自動メール①の送信フラグ |
| **前日案内送信済み** | 自動メール②の送信フラグ |
| **カレンダーイベントID**| Googleカレンダー連携用ID |

## 5. 設定 (`config.js`)
環境（本番/テスト）の切り替えを `config.js` と Script Properties (`APP_MODE`) で管理。

- **APP_MODE**: `prod` (本番) / `test` (テスト)
- **設定項目**:
    - スプレッドシートID
    - カレンダーID
    - メール設定
        - 送信者名
        - DRY_RUN (誤送信防止)
        - 管理者署名
