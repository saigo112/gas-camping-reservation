<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-capable" content="yes">

  <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/d/1mPVRYuQw63S4QEoOeMYo9HnR3gvjc2br=s1024">
  <link rel="icon" href="https://lh3.googleusercontent.com/d/1mPVRYuQw63S4QEoOeMYo9HnR3gvjc2br=s1024">

  <title>ã‚­ãƒ£ãƒ³ãƒ—å ´äºˆç´„ç®¡ç†</title>

  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

  <style>
    /* --- ãƒ™ãƒ¼ã‚¹è¨­å®š --- */
    :root {
      --primary-color: #2E7D32;
      --bg-color: #f7f9fc;
      --nav-height: 60px;

      --color-reserve: #E53935;
      /* èµ¤ (äºˆç´„ä¸­) */
      --color-checkin: #9E9E9E;
      /* ã‚°ãƒ¬ãƒ¼ (å®Œäº†) */
      --color-cancel: #C5A065;
      /* è–„ã„é»„åœŸè‰² (ã‚­ãƒ£ãƒ³ã‚»ãƒ«) */
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 0;
      padding-top: 130px;
      padding-bottom: calc(var(--nav-height) + 20px);
    }

    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« --- */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background-color: var(--primary-color);
      color: white;
      padding: 15px 20px;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .reload-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      cursor: pointer;
    }

    .controls {
      position: fixed;
      top: 60px;
      left: 0;
      width: 100%;
      background-color: white;
      padding: 10px 15px;
      z-index: 999;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 10px;
    }

    .search-box {
      flex: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ddd;
      background: #f0f2f5;
      font-size: 16px;
    }

    .filter-select {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: white;
      font-size: 14px;
    }

    /* --- ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ --- */
    .view-section {
      display: none;
      padding: 15px;
      max-width: 800px;
      margin: 0 auto;
    }

    .view-section.active {
      display: block;
    }

    /* --- ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ --- */
    #card-container {
      display: grid;
      gap: 15px;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border-left: 5px solid transparent;
    }

    .card:active {
      transform: scale(0.98);
    }

    .status-reserve {
      border-left-color: var(--color-reserve);
    }

    .status-checkin {
      border-left-color: var(--color-checkin);
      opacity: 0.8;
    }

    .status-cancel {
      border-left-color: var(--color-cancel);
      opacity: 0.6;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      color: white;
      font-weight: bold;
    }

    .bg-reserve {
      background: var(--color-reserve);
    }

    .bg-checkin {
      background: var(--color-checkin);
    }

    .bg-cancel {
      background: var(--color-cancel);
    }

    .bg-platform {
      background: #1976D2;
    }

    /* é’ç³»ã®è‰²ã§ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒãƒƒã‚¸ */
    .bg-platform-nap {
      background: #43A047;
    }

    /* ç·‘ç³»ã®è‰²ã§ãªã£ã·ãƒãƒƒã‚¸ */

    .card-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .card-body h2 {
      margin: 0 0 5px 0;
      font-size: 1.1rem;
    }

    .card-info {
      font-size: 0.9rem;
      color: #666;
    }

    .card-footer {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      font-weight: bold;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-outline {
      background: white;
      border: 1px solid #ddd;
    }

    /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ --- */
    #calendar-wrapper {
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .fc-event {
      cursor: pointer;
      border: none;
    }

    .fc-event-main {
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* --- è¨­å®šãƒ“ãƒ¥ãƒ¼ --- */
    .settings-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .settings-header {
      font-weight: bold;
      margin-bottom: 15px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-header .tag {
      font-size: 0.8rem;
      background: #eee;
      padding: 3px 8px;
      border-radius: 4px;
      color: #555;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }

    .form-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }

    .form-textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      height: 150px;
      resize: vertical;
      font-family: sans-serif;
      line-height: 1.5;
    }

    .tag-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .tag-badge {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #c8e6c9;
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.8rem;
      cursor: pointer;
      user-select: none;
    }

    .tag-badge:active {
      background: #c8e6c9;
      transform: scale(0.95);
    }

    .save-btn-area {
      text-align: center;
      margin-top: 20px;
    }

    .btn-save {
      background: var(--primary-color);
      color: white;
      width: 100%;
      padding: 15px;
      font-size: 1.1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .btn-save:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* --- ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ --- */
    nav.bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: var(--nav-height);
      background: white;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1000;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      color: #888;
      padding: 5px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: bold;
    }

    .nav-item.active {
      color: var(--primary-color);
    }

    .nav-icon {
      font-size: 1.5rem;
      margin-bottom: 2px;
    }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
    #modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
      align-items: flex-end;
    }

    @media(min-width:600px) {
      #modal-overlay {
        align-items: center;
      }
    }

    #modal-content {
      background: white;
      width: 100%;
      max-width: 600px;
      border-radius: 15px 15px 0 0;
      padding: 25px;
      max-height: 90vh;
      overflow-y: auto;
      margin: 0 auto;
    }

    @media(min-width:600px) {
      #modal-content {
        border-radius: 12px;
        width: 90%;
      }
    }

    .detail-group {
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }

    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 3000;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--primary-color);
      font-weight: bold;
    }

    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 2px;
      padding: 16px;
      position: fixed;
      z-index: 3001;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%);
      font-size: 14px;
    }

    #toast.show {
      visibility: visible;
      -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }

    @-webkit-keyframes fadein {
      from {
        bottom: 0;
        opacity: 0;
      }

      to {
        bottom: 80px;
        opacity: 1;
      }
    }

    @keyframes fadein {
      from {
        bottom: 0;
        opacity: 0;
      }

      to {
        bottom: 80px;
        opacity: 1;
      }
    }

    @-webkit-keyframes fadeout {
      from {
        bottom: 80px;
        opacity: 1;
      }

      to {
        bottom: 0;
        opacity: 0;
      }
    }

    @keyframes fadeout {
      from {
        bottom: 80px;
        opacity: 1;
      }

      to {
        bottom: 0;
        opacity: 0;
      }
    }
  </style>
</head>

<body>

  <div id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  <div id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <header>
    <h1>BAMPO CAMP Admin</h1>
    <button class="reload-btn" onclick="location.reload()">å†èª­è¾¼</button>
  </header>

  <div class="controls" id="list-controls">
    <input type="text" class="search-box" id="search-input" placeholder="åå‰æ¤œç´¢..." oninput="applyFilter()">
    <select class="filter-select" id="status-filter" onchange="applyFilter()">
      <option value="all">å…¨ã¦</option>
      <option value="äºˆç´„ä¸­" selected>äºˆç´„ä¸­</option>
      <option value="ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†">å®Œäº†</option>
      <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿">å–æ¶ˆ</option>
    </select>
  </div>

  <div id="view-list" class="view-section active">
    <div id="card-container"></div>
  </div>

  <div id="view-calendar" class="view-section">
    <div id="calendar-wrapper">
      <div id="calendar"></div>
    </div>
  </div>

  <div id="view-settings" class="view-section">
    <div id="settings-container"></div>
    <div class="save-btn-area">
      <button class="btn-save" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-item active" onclick="switchView('list')">
      <span class="nav-icon">â˜°</span>
      ãƒªã‚¹ãƒˆ
    </div>
    <div class="nav-item" onclick="switchView('calendar')">
      <span class="nav-icon">ğŸ“…</span>
      ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
    </div>
    <div class="nav-item" onclick="switchView('settings')">
      <span class="nav-icon">âš™</span>
      è¨­å®š
    </div>
  </nav>

  <div id="modal-overlay" onclick="if(event.target === this) closeModal()">
    <div id="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">è©³ç´°æƒ…å ±</h2>
        <span style="font-size:1.5rem; cursor:pointer;" onclick="closeModal()">Ã—</span>
      </div>
      <div id="modal-body"></div>
      <div id="modal-actions" style="margin-top:20px; display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </div>

  <script>
    let allData = [];
    let calendar = null;

    // â˜…è‰²ã®å®šç¾©ï¼ˆCSSå¤‰æ•°ã¨åˆã‚ã›ã‚‹ï¼‰
    const COLOR_RESERVE = '#E53935';
    const COLOR_CHECKIN = '#9E9E9E';
    const COLOR_CANCEL = '#C5A065';

    window.onload = loadData;

    function loadData() {
      document.getElementById('loading').style.display = 'flex';
      google.script.run
        .withSuccessHandler(function (data) {
          allData = data;
          applyFilter();
          initCalendar();
          document.getElementById('loading').style.display = 'none';
        })
        .getDataForWeb();
    }

    function switchView(viewName) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));

      const navIndex = viewName === 'list' ? 0 : viewName === 'calendar' ? 1 : 2;
      document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
      document.getElementById('view-' + viewName).classList.add('active');

      const controls = document.getElementById('list-controls');
      controls.style.display = (viewName === 'list') ? 'flex' : 'none';

      if (viewName === 'calendar') {
        setTimeout(() => { if (calendar) calendar.render(); }, 100);
      }
      if (viewName === 'settings') {
        loadSettings();
      }
    }

    // --- è¨­å®šæ©Ÿèƒ½ ---
    function loadSettings() {
      document.getElementById('loading').style.display = 'flex';
      google.script.run
        .withSuccessHandler(renderSettings)
        .getEmailSettings();
    }

    function renderSettings(settings) {
      const container = document.getElementById('settings-container');
      container.innerHTML = '';
      document.getElementById('loading').style.display = 'none';

      const labelMap = {
        'reserve_next_day': 'â‘  äºˆç´„ç¿Œæ—¥ãƒ¡ãƒ¼ãƒ« (å—äº¬éŒ )',
        'checkin_prev_day': 'â‘¡ å®¿æ³Šå‰æ—¥ãƒ¡ãƒ¼ãƒ« (ãƒªãƒã‚¤ãƒ³ãƒ‰)',
        'common_signature': 'å…±é€šã®ç½²å (ãƒ•ãƒƒã‚¿ãƒ¼)'
      };

      const availableTags = [
        '{åå‰}', '{äºˆç´„ID}', '{ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥}', '{ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥}',
        '{ã‚µã‚¤ãƒˆå}', '{æ–™é‡‘}', '{å—äº¬éŒ }', '{å‚™è€ƒ}'
      ];

      const tagsHtml = availableTags.map(tag =>
        `<span class="tag-badge" onclick="copyTag(this)">${tag}</span>`
      ).join('');

      settings.forEach(item => {
        const displayTitle = labelMap[item.key] || item.key;
        const isSignature = (item.key === 'common_signature');

        const card = document.createElement('div');
        card.className = 'settings-card';

        let contentHtml = '';

        if (isSignature) {
          contentHtml = `
              <div class="form-group">
                <label class="form-label">ç½²åæœ¬æ–‡</label>
                <textarea class="form-textarea setting-body">${item.body}</textarea>
              </div>
              <input type="hidden" class="setting-subject" value="${item.subject}">
              <input type="hidden" class="setting-attach" value="${item.attachments}">
            `;
        } else {
          contentHtml = `
              <div class="form-group">
                <label class="form-label">ä»¶å</label>
                <input type="text" class="form-input setting-subject" value="${item.subject}">
              </div>
              <div class="form-group">
                <label class="form-label">æœ¬æ–‡ (ã‚¿ãƒƒãƒ—ã—ã¦ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼)</label>
                <div class="tag-container">${tagsHtml}</div>
                <textarea class="form-textarea setting-body">${item.body}</textarea>
              </div>
              <div class="form-group">
                <label class="form-label">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ID (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                <input type="text" class="form-input setting-attach" value="${item.attachments}">
              </div>
            `;
        }

        card.innerHTML = `
            <div class="settings-header">
              <span>${displayTitle}</span>
              <span class="tag">${item.key}</span>
            </div>
            <input type="hidden" class="setting-key" value="${item.key}">
            ${contentHtml}
          `;
        container.appendChild(card);
      });
    }

    function copyTag(element) {
      const text = element.innerText;
      navigator.clipboard.writeText(text).then(function () {
        showToast(`"${text}" ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
      }, function (err) {
        console.error('Copy failed', err);
      });
    }

    function showToast(message) {
      const x = document.getElementById("toast");
      x.innerText = message;
      x.className = "show";
      setTimeout(function () { x.className = x.className.replace("show", ""); }, 3000);
    }

    function saveSettings() {
      if (!confirm('è¨­å®šã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;
      document.getElementById('loading').style.display = 'flex';
      const cards = document.querySelectorAll('.settings-card');
      const newSettings = [];
      cards.forEach(card => {
        newSettings.push({
          key: card.querySelector('.setting-key').value,
          subject: card.querySelector('.setting-subject').value,
          body: card.querySelector('.setting-body').value,
          attachments: card.querySelector('.setting-attach').value
        });
      });
      google.script.run
        .withSuccessHandler(function (res) {
          document.getElementById('loading').style.display = 'none';
          alert(res.message);
        })
        .saveEmailSettings(newSettings);
    }

    // --- ãƒªã‚¹ãƒˆè¡¨ç¤º ---
    function applyFilter() {
      const searchText = document.getElementById('search-input').value.toLowerCase();
      const statusFilter = document.getElementById('status-filter').value;
      const filteredData = allData.filter(row => {
        if (statusFilter !== 'all' && row.status !== statusFilter) return false;
        return (row.name && row.name.toLowerCase().includes(searchText)) ||
          (row.site && row.site.toLowerCase().includes(searchText));
      });
      renderCards(filteredData);
    }

    function renderCards(data) {
      const container = document.getElementById('card-container');
      container.innerHTML = '';
      if (data.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#888; grid-column:1/-1; padding:20px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      data.forEach(row => {
        let statusClass = 'status-reserve';
        let badgeClass = 'bg-reserve';

        if (row.status === 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†') { statusClass = 'status-checkin'; badgeClass = 'bg-checkin'; }
        else if (row.status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿') { statusClass = 'status-cancel'; badgeClass = 'bg-cancel'; }

        // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒãƒƒã‚¸ã®è‰²åˆ†ã‘
        const platformBadgeClass = row.platform === 'ãªã£ã·' ? 'bg-platform-nap' : 'bg-platform';

        let checkinBtn = '';
        if (row.status === 'äºˆç´„ä¸­') {
          checkinBtn = `<button class="btn btn-primary" onclick="event.stopPropagation(); changeStatus('${row.id}', 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†')">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</button>`;
        }

        const card = document.createElement('div');
        card.className = `card ${statusClass}`;
        card.onclick = () => openModal(row.id);

        card.innerHTML = `
            <div class="card-header">
              <div style="display:flex; gap:5px;">
                <span class="badge ${platformBadgeClass}">${row.platform}</span>
                <span class="badge ${badgeClass}">${row.status}</span>
              </div>
              <small style="color:#999;">${row.checkIn.split(' ')[1] || ''} IN</small>
            </div>
            <div class="card-body">
              <h2>${row.name} æ§˜</h2>
              <div class="card-info">
                <div>ğŸ“… ${row.checkIn.split(' ')[0]} ï½ ${row.checkOut.split(' ')[0]}</div>
                <div>â›º ${row.site} (${row.siteCount})</div>
              </div>
            </div>
            <div class="card-footer">
              ${checkinBtn}
              <button class="btn btn-outline" onclick="event.stopPropagation(); openModal('${row.id}')">è©³ç´°</button>
            </div>
          `;
        container.appendChild(card);
      });
    }

    // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ---
    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      const events = allData.map(row => {
        let color = '#2E7D32'; // ãã®ä»–
        if (row.status === 'äºˆç´„ä¸­') {
          if (row.platform === 'ãªã£ã·') {
            color = '#43A047'; // ãªã£ã·ï¼ˆç·‘ï¼‰
          } else {
            color = '#E53935'; // æ¥½å¤©ãƒˆãƒ©ãƒ™ãƒ«ï¼ˆèµ¤ï¼‰
          }
        } else if (row.status === 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†') {
          color = COLOR_CHECKIN;
        } else if (row.status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿') {
          color = COLOR_CANCEL;
        }

        const platformShort = row.platform === 'ãªã£ã·' ? 'ãªã£ã·' : 'æ¥½å¤©';

        return {
          id: row.id,
          title: `[${platformShort}] ${row.name} (${row.site})`,
          start: row.startIso,
          end: row.endIso,
          color: color,
          textColor: '#fff' // ç™½æ–‡å­—
        };
      });

      if (calendar) {
        calendar.removeAllEvents();
        calendar.addEventSource(events);
        return;
      }

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        height: 'auto',
        // â˜…ã“ã“ã§ã‚¤ãƒ™ãƒ³ãƒˆã®è¡¨ç¤ºå½¢å¼ã‚’ã€Œãƒ–ãƒ­ãƒƒã‚¯ã€ã«å¼·åˆ¶ã™ã‚‹
        eventDisplay: 'block',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' },
        buttonText: { today: 'ä»Šæ—¥', month: 'æœˆ', list: 'ãƒªã‚¹ãƒˆ' },
        events: events,
        eventClick: function (info) { openModal(info.event.id); }
      });
      calendar.render();
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ« (å…±é€š) ---
    function openModal(id) {
      const row = allData.find(d => d.id === id);
      if (!row) return;

      const body = document.getElementById('modal-body');
      const actions = document.getElementById('modal-actions');

      body.innerHTML = `
          <div class="detail-group"><div class="detail-label">ãŠåå‰</div><div class="detail-value">${row.name} æ§˜</div></div>
          <div class="detail-group"><div class="detail-label">é›»è©±ç•ªå·</div><div class="detail-value"><a href="tel:${row.phone}">${row.phone}</a></div></div>
          <div class="detail-group"><div class="detail-label">åˆ©ç”¨ã‚µã‚¤ãƒˆ</div><div class="detail-value">${row.site} (${row.siteCount}åŒºç”»)</div></div>
          <div class="detail-group"><div class="detail-label">æ—¥æ™‚</div><div class="detail-value">${row.checkIn} ï½ ${row.checkOut}</div></div>
          <div class="detail-group"><div class="detail-label">äººæ•°</div><div class="detail-value">å¤§äºº${row.adult} / å­ä¾›${row.child} / å¹¼å…${row.infant}</div></div>
          <div class="detail-group"><div class="detail-label">æ–™é‡‘</div><div class="detail-value" style="font-weight:bold; color:${COLOR_RESERVE};">${row.price}</div></div>
          <div class="detail-group"><div class="detail-label">å‚™è€ƒ</div><div class="detail-value" style="background:#f9f9f9; padding:10px; font-size:0.9rem;">${row.remarks || 'ãªã—'}</div></div>
          <div class="detail-group"><div class="detail-label">äºˆç´„ID</div><div class="detail-value" style="font-size:0.8rem; color:#aaa;">${row.id}</div></div>
        `;

      if (row.status === 'äºˆç´„ä¸­') {
        actions.innerHTML = `
            <button class="btn-save" style="background:${COLOR_RESERVE};" onclick="changeStatus('${row.id}', 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†'); closeModal();">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å®Œäº†</button>
            <button class="btn-save" style="background:#ffebee; color:#d32f2f; margin-top:10px;" onclick="changeStatus('${row.id}', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿'); closeModal();">äºˆç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          `;
      } else {
        actions.innerHTML = `<div style="text-align:center; color:#999; padding:10px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${row.status}</div>`;
      }

      document.getElementById('modal-overlay').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function changeStatus(id, newStatus) {
      if (!confirm(`${newStatus} ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      const target = allData.find(d => d.id === id);
      if (target) {
        target.status = newStatus;
        let newColor = COLOR_CHECKIN;
        if (newStatus === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿') newColor = COLOR_CANCEL;
        if (calendar) { const ev = calendar.getEventById(id); if (ev) ev.setProp('color', newColor); }
      }
      applyFilter();

      google.script.run
        .withSuccessHandler(() => loadData())
        .updateReservationStatus(id, newStatus);
    }
  </script>
</body>

</html>